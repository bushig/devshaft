{% extends 'base.html' %}

{% block content %}
    <div class="row">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h1>{{ entry.name }}
                    <small>{{ entry.category }}</small>
                </h1>
            {% if user.is_authenticated %}
                {% if entry.user == user %}
                    <a href="{% url 'assets:add_version' entry.id %}" class="btn btn-success btn-xs" role="button">Add
                        version</a> {% endif %}
                <a href="{% url 'assets:edit' entry.id %}" class="btn btn-info btn-xs" role="button">Edit</a>
                <button type="button" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#ModalDelete">
                    Delete asset
                </button>
            {% endif %}
            <a class="btn btn-info btn-xs" href="{% url 'assets:revisions_list' entry.id %}"><i class="far fa-save"></i> Revisions</a>
            </div>
            {% comment %} CAROUSEL {% endcomment %}
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-5">
                        {% include 'carousel.html' %}
                    </div>
                    <div class="col-lg-7">
                        <p>{{ entry.description }}</p>
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th><i class="fas fa-star"></i>Stars</th>
                                <th><i class="fas fa-code-branch"></i>Forks</th>
                                <th><i class="far fa-calendar-alt"></i> Repo fetched</th>
                                <th><i class="fas fa-chart-bar"></i>Stats</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>{{ entry.repo_stars }}</td>
                                <td>{{ entry.repo_forks }}</td>
                                <td>{{ entry.repo_updated | timesince }} ago</td>
                                <td><img
                                        src="https://chart.googleapis.com/chart?cht=bvg&chs=105x20&chd=t:{{ entry.commits }}&chco=666666&chbh=1,1,1&chds=0,50">
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        {% if entry.user == user %}
                            <br><i class="fas fa-thumbs-up"></i> {{ entry.users_liked__count }}
                            <a href="{% url 'assets:fetch_metadata' entry.id %}" class="btn btn-default btn-xs"><i
                                    class="fab fa-github"></i> Fetch
                                metadata</a>

                        {% elif user.is_authenticated %}
                            <button id="likes_asset" data-entryid="{{ entry.id }}" class="btn
                {% if user_liked %}
                btn-success active" type="button">
                                <i class="fa fa-thumbs-up"></i>
                                <span id="liked">Liked </span>
                                <span id='likes_count'>{{ entry.users_liked__count }}</span>

                            {% else %}
                                btn-default
                                " type="button">
                                <i class="fa fa-thumbs-up"></i>
                                <span id="liked">Like </span>
                                <span id='likes_count'>{{ entry.users_liked__count }}</span>
                            {% endif %}
                            </button>
                            <a href="{% url 'assets:fetch_metadata' entry.id %}" class="btn btn-default btn-xs"><i
                                    class="fab fa-github"></i> Fetch
                                metadata</a>
                        {% else %}
                            <hr><i class="fa fa-thumbs-up"></i> {{ entry.users_liked__count }}
                        {% endif %}
                    {% if entry.repository %}
                        <br><a href="{{ entry.repository }}">Repo</a>
                    {% endif %}
                    {% if entry.site %}
                        <br><a href="{{ entry.site }}">Site</a>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">


            <div class="panel panel-default col-lg-6">
                <h1>Changelog</h1>
                {% for version in versions %}
                    <hr>
                    <h5><strong>{{ version.version }}</strong></h5>
                    <p>{{ version.changelog| linebreaks }}</p>
                {% endfor %}
            </div>
            <div class="panel panel-default col-lg-6">
                <a href="{% url 'assets:entry_versions' entry.id %}"><h1>Versions</h1></a>
                {% if versions %}
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th>Version</th>
                            <th>Date</th>
                            <th>Download</th>
                        </tr>
                        {% for version in versions %}
                            {% with uploads=version.uploads.all %}
{#                                TODO edit so only owner will see empty releases #}
                            <tr>
                                <td>{{ version.version }}</td>
                                <td><p href="#" data-toggle="tooltip"
                                       title="{{ version.timestamp }}">{{ version.timestamp | timesince }} ago</p></td>
                                <td>
                                        <table class="table table-bordered table-striped">
                                            <tr>
                                                <th>Note</th>
                                                <th>Action</th>
                                            </tr>
                                            {% for upload in uploads %}
                                                <tr>
                                                    <td>{{ upload.note }}</td>
                                                    <td>
                                                        <a href="{{ MEDIA_URL }}{{ upload.file }}"
                                                           class="btn btn-default btn-xs">Download</a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </table>
                                    {% if entry.user == user %}
                                        <a href="{% url 'assets:edit_version' entry.id version.id %}"
                                           class="btn btn-info"
                                           role="button">Edit</a>
{#                                        <button type="button" class="btn btn-danger">Delete</button>#}
                                    {% endif %}

                                </td>
                            </tr>
                            {% endwith %}
                        {% endfor %}

                    </table>
                    {#        <a href="{% url 'assets:entry_versions' entry.id %}" class="btn btn-info" role="button">View all</a>#}
                {% else %}
                    <h1>No versions yet</h1>
                {% endif %}
            </div>
    </div>

    {% comment %} MODAL {% endcomment %}
    <div class="modal fade" id="ModalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="DeleteEntryButton">Delete</h4>
                </div>
                <div class="modal-body">
                    Do you want to delete this asset?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="deleteEntry" type="button" data-entryid="{{ entry.id }}" class="btn btn-danger">Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
{% endblock %}